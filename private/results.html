<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Survey Results</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
      .results-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 12px;
        margin-bottom: 18px;
      }

      .metric {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
        background: #f9fafb;
      }

      .metric-title {
        font-size: 12px;
        color: #6b7280;
        margin-bottom: 6px;
      }

      .metric-value {
        font-size: 24px;
        font-weight: 700;
        line-height: 1.1;
      }

      .insights-list {
        margin: 0;
        padding-left: 20px;
      }

      .insights-list li {
        margin: 6px 0;
      }

      .dist-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 12px;
      }

      .dist-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        padding: 12px;
      }

      .dist-card h3 {
        margin: 0 0 8px;
        font-size: 14px;
      }

      .dist-item {
        margin: 8px 0;
      }

      .dist-row {
        display: flex;
        justify-content: space-between;
        gap: 8px;
        margin-bottom: 4px;
        font-size: 13px;
      }

      .bar {
        height: 7px;
        background: #e5e7eb;
        border-radius: 999px;
        overflow: hidden;
      }

      .bar > span {
        display: block;
        height: 100%;
        background: #111827;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      .results-table th,
      .results-table td {
        text-align: left;
        vertical-align: top;
        border-bottom: 1px solid #f3f4f6;
        padding: 8px;
      }

      .pill {
        display: inline-block;
        border: 1px solid #d1d5db;
        border-radius: 999px;
        padding: 2px 8px;
        margin: 2px 4px 2px 0;
        font-size: 12px;
        color: #374151;
        background: #f9fafb;
      }

      .comments {
        margin: 0;
        padding-left: 18px;
      }

      .raw {
        white-space: pre-wrap;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 12px;
        background: #f9fafb;
      }

      @media (max-width: 820px) {
        .results-grid,
        .dist-grid {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body>
    <main class="container">
      <h1>Survey Results</h1>
      <p class="subtitle" id="meta">Loading…</p>

      <section>
        <h2>Overview</h2>
        <div class="results-grid" id="metrics"></div>
      </section>

      <section>
        <h2>Auto Insights</h2>
        <ul class="insights-list" id="insights"></ul>
      </section>

      <section>
        <h2>Distributions</h2>
        <div class="dist-grid" id="distributions"></div>
      </section>

      <section>
        <h2>All Submissions</h2>
        <div style="overflow: auto">
          <table id="resultsTable" class="results-table"></table>
        </div>
      </section>

      <section>
        <h2>Latest Comments</h2>
        <ul class="comments" id="comments"></ul>
      </section>

      <section>
        <h2>Raw JSON</h2>
        <pre id="raw" class="raw"></pre>
      </section>
    </main>

    <script>
      const key = window.location.pathname.split('/').filter(Boolean).pop();
      const metaNode = document.getElementById('meta');
      const metricsNode = document.getElementById('metrics');
      const insightsNode = document.getElementById('insights');
      const distributionsNode = document.getElementById('distributions');
      const tableNode = document.getElementById('resultsTable');
      const commentsNode = document.getElementById('comments');
      const rawNode = document.getElementById('raw');

      function escapeHtml(value) {
        return String(value)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#39;');
      }

      function formatAnswers(answers) {
        if (!answers || typeof answers !== 'object') {
          return '';
        }

        return Object.entries(answers)
          .map(([name, value]) => {
            if (Array.isArray(value)) {
              return `<div><strong>${escapeHtml(name)}:</strong> ${escapeHtml(value.join(', '))}</div>`;
            }

            return `<div><strong>${escapeHtml(name)}:</strong> ${escapeHtml(value ?? '')}</div>`;
          })
          .join('');
      }

      function getCounter(rows, fieldName) {
        const counter = new Map();

        rows.forEach((item) => {
          const value = item?.answers?.[fieldName];
          if (value === null || value === undefined || value === '') {
            return;
          }

          const keyName = String(value);
          counter.set(keyName, (counter.get(keyName) || 0) + 1);
        });

        return Array.from(counter.entries())
          .map(([name, count]) => ({ name, count }))
          .sort((a, b) => b.count - a.count);
      }

      function getArrayCounter(rows, fieldName) {
        const counter = new Map();

        rows.forEach((item) => {
          const values = item?.answers?.[fieldName];
          if (!Array.isArray(values)) {
            return;
          }

          values.forEach((value) => {
            if (!value) {
              return;
            }

            const keyName = String(value);
            counter.set(keyName, (counter.get(keyName) || 0) + 1);
          });
        });

        return Array.from(counter.entries())
          .map(([name, count]) => ({ name, count }))
          .sort((a, b) => b.count - a.count);
      }

      function getTopItem(items) {
        if (!items.length) {
          return null;
        }

        return items[0];
      }

      function renderMetrics(data, rows) {
        const impacts = rows
          .map((item) => Number(item?.answers?.impactDelivery))
          .filter((value) => Number.isFinite(value));

        const avgImpact = impacts.length
          ? (impacts.reduce((sum, value) => sum + value, 0) / impacts.length).toFixed(2)
          : 'n/a';

        const commentsCount = rows.filter((item) => {
          const text = item?.answers?.comment;
          return typeof text === 'string' && text.trim().length > 0;
        }).length;

        metricsNode.innerHTML = `
          <article class="metric">
            <div class="metric-title">Total submissions</div>
            <div class="metric-value">${data.totalSubmissions}</div>
          </article>
          <article class="metric">
            <div class="metric-title">Average impact delivery (1-5)</div>
            <div class="metric-value">${avgImpact}</div>
          </article>
          <article class="metric">
            <div class="metric-title">Comments left</div>
            <div class="metric-value">${commentsCount}</div>
          </article>
        `;
      }

      function renderDistributionCard(title, items, totalRows) {
        if (!items.length) {
          return `
            <article class="dist-card">
              <h3>${escapeHtml(title)}</h3>
              <div class="dist-item">No data</div>
            </article>
          `;
        }

        return `
          <article class="dist-card">
            <h3>${escapeHtml(title)}</h3>
            ${items
              .map((item) => {
                const percent = totalRows > 0 ? Math.round((item.count / totalRows) * 100) : 0;
                return `
                  <div class="dist-item">
                    <div class="dist-row">
                      <span>${escapeHtml(item.name)}</span>
                      <span>${item.count} (${percent}%)</span>
                    </div>
                    <div class="bar"><span style="width:${percent}%"></span></div>
                  </div>
                `;
              })
              .join('')}
          </article>
        `;
      }

      function renderDistributions(rows) {
        const byRole = getCounter(rows, 'role');
        const byTeamSize = getCounter(rows, 'teamSize');
        const byMaturity = getCounter(rows, 'maturity');
        const byFrequency = getCounter(rows, 'teamFrequency');
        const byBlocker = getCounter(rows, 'blocker');
        const byAreas = getArrayCounter(rows, 'areas');

        distributionsNode.innerHTML = [
          renderDistributionCard('Role', byRole, rows.length),
          renderDistributionCard('Team size', byTeamSize, rows.length),
          renderDistributionCard('Maturity', byMaturity, rows.length),
          renderDistributionCard('Team usage frequency', byFrequency, rows.length),
          renderDistributionCard('Biggest blocker', byBlocker, rows.length),
          renderDistributionCard('AI areas used', byAreas, rows.length)
        ].join('');

        return { byRole, byTeamSize, byMaturity, byFrequency, byBlocker, byAreas };
      }

      function renderInsights(rows, distributions) {
        if (!rows.length) {
          insightsNode.innerHTML = '<li>Not enough data yet.</li>';
          return;
        }

        const topRole = getTopItem(distributions.byRole);
        const topBlocker = getTopItem(distributions.byBlocker);
        const topArea = getTopItem(distributions.byAreas);
        const topFrequency = getTopItem(distributions.byFrequency);

        const impacts = rows
          .map((item) => Number(item?.answers?.impactDelivery))
          .filter((value) => Number.isFinite(value));
        const avgImpact = impacts.length
          ? (impacts.reduce((sum, value) => sum + value, 0) / impacts.length).toFixed(2)
          : null;

        const insights = [];

        if (topRole) {
          insights.push(`Most responses come from: ${topRole.name} (${topRole.count}).`);
        }

        if (topArea) {
          insights.push(`Most common AI usage area: ${topArea.name} (${topArea.count} mentions).`);
        }

        if (topBlocker) {
          insights.push(`Top blocker: ${topBlocker.name} (${topBlocker.count} responses).`);
        }

        if (topFrequency) {
          insights.push(`Typical usage cadence: ${topFrequency.name}.`);
        }

        if (avgImpact !== null) {
          insights.push(`Average perceived delivery impact: ${avgImpact} / 5.`);
        }

        insightsNode.innerHTML = insights.map((text) => `<li>${escapeHtml(text)}</li>`).join('');
      }

      function renderTable(rows) {
        tableNode.innerHTML = `
          <thead>
            <tr>
              <th>Submitted At</th>
              <th>Role</th>
              <th>Team Size</th>
              <th>Maturity</th>
              <th>Blocker</th>
              <th>Areas</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody>
            ${rows
              .map((item) => {
                const answers = item.answers || {};
                const areas = Array.isArray(answers.areas) ? answers.areas : [];

                return `
                  <tr>
                    <td>${escapeHtml(item.submittedAt || '')}</td>
                    <td>${escapeHtml(answers.role || '')}</td>
                    <td>${escapeHtml(answers.teamSize || '')}</td>
                    <td>${escapeHtml(answers.maturity || '')}</td>
                    <td>${escapeHtml(answers.blocker || '')}</td>
                    <td>${areas.map((name) => `<span class="pill">${escapeHtml(name)}</span>`).join('')}</td>
                    <td>${formatAnswers(answers)}</td>
                  </tr>
                `;
              })
              .join('') || '<tr><td colspan="7">No submissions yet.</td></tr>'}
          </tbody>
        `;
      }

      function renderComments(rows) {
        const comments = rows
          .map((item) => ({
            submittedAt: item.submittedAt,
            comment: item?.answers?.comment
          }))
          .filter((item) => typeof item.comment === 'string' && item.comment.trim().length > 0)
          .slice(-10)
          .reverse();

        if (!comments.length) {
          commentsNode.innerHTML = '<li>No comments yet.</li>';
          return;
        }

        commentsNode.innerHTML = comments
          .map((item) => `<li><strong>${escapeHtml(item.submittedAt || '')}:</strong> ${escapeHtml(item.comment)}</li>`)
          .join('');
      }

      async function loadResults() {
        try {
          const response = await fetch(`/api/results/${encodeURIComponent(key)}`);
          if (!response.ok) {
            throw new Error('Could not load results');
          }

          const data = await response.json();
          const rows = data.submissions || [];

          metaNode.textContent = `Total submissions: ${data.totalSubmissions}${data.lastSubmittedAt ? ` · Last: ${new Date(data.lastSubmittedAt).toLocaleString()}` : ''}`;

          renderMetrics(data, rows);
          const distributions = renderDistributions(rows);
          renderInsights(rows, distributions);
          renderTable(rows);
          renderComments(rows);

          rawNode.textContent = JSON.stringify(data, null, 2);
        } catch (error) {
          metaNode.textContent = 'Could not load results.';
          metricsNode.innerHTML = '';
          insightsNode.innerHTML = '';
          distributionsNode.innerHTML = '';
          tableNode.innerHTML = '';
          commentsNode.innerHTML = '';
          rawNode.textContent = '';
        }
      }

      loadResults();
    </script>
  </body>
</html>
